<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    svg {
        padding: 0;
        display: block;
        margin: 0 auto;
        max-height: 100%;
        max-width: 100%;
    }    
</style>
</head>
<body>
    <svg id = "gameview" 
        viewBox = "0 40 200 200"
        xmlns="http://www.w3.org/2000/svg">
        <defs>
            <clipPath id="bbox">
                <rect x=0 y=40 width=200 height=200></rect>
            </clipPath>
        </defs>
        <g clip-path="url(#bbox)">

        <g id="everything">
            <g id="course">
                <rect
                    style="fill:#788921;stroke:none;"
                    width="360"
                    height="360"
                    x="-80"
                    y="-40">
                </rect>
                <path
                    transform="matrix(1.5,-.3,.3,1.5,-5,95)"
                    style="fill:#00428e;fill-opacity:1;stroke:#000000;stroke-width:0.31573px;stroke-linejoin:round;"
                    d="m 0,0 c 20.604062,-2.538588 14.856752,4.362873 17.886762,8.805393 3.030007,4.44253 12.716331,8.33008 11.504326,12.45528 -1.212002,4.12521 -0.676139,8.23625 -6.140796,8.82828 -2.452836,0.26573 -3.286283,0.57628 -5.653091,-1.28273 0,0 -1.957508,-0.54303 -2.732328,1.28272 -1.130619,2.66414 0,1.0854 0.09422,6.80837 0.09422,5.72296 -4.428255,5.72296 -3.768728,9.86718 0.659527,4.14421 0.565309,7.59772 -0.942182,10.26186 -1.507492,2.66415 -8.196985,4.63758 -10.740877,4.04554 -2.543892,-0.59203 -9.9871309,-5.13093 -11.3061857,-9.57115 -1.3190551,-4.44024 -2.9207647,-7.69641 -2.5438918,-11.84063 0.3768728,-4.14421 2.3605317,-16.50975 3.6745104,-17.95826 1.790146,-1.97344 4.0513831,-1.97344 4.9935653,-5.52564 0.3229348,-1.21751 -1.6017098,-4.73624 -4.5224745,-6.11765 -2.9207645,-1.3814 -1.0204736,-5.73964 -0.4710908,-6.31499 2.6381097,-2.762811 5.6963041,-2.55355 10.6682631,-3.743573 z">
                </path>
                <g transform="matrix(0.5,0,0,0.5,102.16107,155.54471)">
                    <circle
                        style="fill:#445016;stroke:#000000;stroke-width:0.42;"
                        r="21"
                        cy="65.436913"
                        cx="47.229565">
                    </circle>
                    <circle
                        style="fill:#668000;stroke:#000000;stroke-width:0.42;"
                        cx="67.35881"
                        cy="68.452728"
                        r="7.9">
                    </circle>
                    <circle
                        style="fill:#445500;stroke:#000000;stroke-width:0.42;"
                        cx="59.604591"
                        cy="56.067226"
                        r="9.8">
                    </circle>
                </g>
                <g transform="matrix(0.4,0,0,0.4,135,65)">
                    <circle
                        style="fill:#445016;stroke:#000000;stroke-width:0.5;"
                        r="21"
                        cy="65.436913"
                        cx="47.229565">
                    </circle>
                    <circle
                        style="fill:#668000;stroke:#000000;stroke-width:0.5;"
                        cx="67.35881"
                        cy="68.452728"
                        r="7.9">
                    </circle>
                    <circle
                        style="fill:#445500;stroke:#000000;stroke-width:0.5;"
                        cx="59.604591"
                        cy="56.067226"
                        r="9.8">
                    </circle>
                </g>
                <g transform="matrix(0.3,0,0,0.3,41.1267529,53.590775)">
                    <circle
                        style="fill:#445016;stroke:#000000;stroke-width:0.6;"
                        r="21"
                        cy="65.436913"
                        cx="47.229565">
                    </circle>
                    <circle
                        style="fill:#668000;stroke:#000000;stroke-width:0.6;"
                        cx="67.35881"
                        cy="68.452728"
                        r="7.9">
                    </circle>
                    <circle
                        style="fill:#445500;stroke:#000000;stroke-width:0.6;"
                        cx="59.604591"
                        cy="56.067226"
                        r="9.8">
                    </circle>
                </g>
                <path
                    style="fill:#917c6f;stroke:#000000;stroke-width:0.5;stroke-linejoin:round;"
                    d="m 27.060839,151.22234 -0.872416,7.73863 -3.599411,7.25972 -7.629469,1.56165 -8.0166825,-1.17986 -3.8428547,-6.77348 -1.3551722,-7.98892 5.2544543,-5.74789 7.1791401,-3.75756 7.090286,3.22109 z"
                    transform="matrix(0.41566518,0,0,0.4253613,51.769569,102.77837)" />
                <path
                    style="fill:#917c6f;stroke:#000000;stroke-width:0.85;stroke-linejoin:round;"
                    transform="matrix(0.2505043,0,0,0.24552157,115.13995,98.718616)"
                    d="m 27.060839,151.22234 -0.872416,7.73863 -3.599411,7.25972 -7.629469,1.56165 -8.0166825,-1.17986 -3.8428547,-6.77348 -1.3551722,-7.98892 5.2544543,-5.74789 7.1791401,-3.75756 7.090286,3.22109 z" />
                <path
                    style="fill:#917c6f;stroke:#000000;stroke-width:0.5;stroke-linejoin:round;"
                    transform="matrix(0.41566518,0,0,0.4253613,171.97739,120.24001)"
                    d="m 27.060839,151.22234 -0.872416,7.73863 -3.599411,7.25972 -7.629469,1.56165 -8.0166825,-1.17986 -3.8428547,-6.77348 -1.3551722,-7.98892 5.2544543,-5.74789 7.1791401,-3.75756 7.090286,3.22109 z" />
                <path
                    style="fill:#917c6f;stroke:#000000;stroke-width:0.5;stroke-linejoin:round;"
                    transform="matrix(0.41566518,0,0,0.4253613,60,181)"
                    d="m 27.060839,151.22234 -0.872416,7.73863 -3.599411,7.25972 -7.629469,1.56165 -8.0166825,-1.17986 -3.8428547,-6.77348 -1.3551722,-7.98892 5.2544543,-5.74789 7.1791401,-3.75756 7.090286,3.22109 z" />
                <g id="road">
                    <path 
                        style="fill:none;stroke:#69500a;stroke-width:10.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;"
                        d="M 57.472004,121.33999 C 76.009256,87.527484 80.275768,63.625541 96.900447,64.06277 c 16.624683,0.437232 12.946653,19.09241 9.562873,37.74759 -3.38378,18.65517 -4.26651,44.59753 7.50317,51.30173 11.76969,6.70421 14.85923,6.26698 18.8315,-5.68399 3.97227,-11.95098 -8.68014,-20.69559 -4.70787,-35.99867 3.97226,-15.303071 0.44136,-49.40707 21.33256,-56.402761 20.89118,-6.995691 26.92314,29.877434 27.07027,47.949631 0.14712,18.07221 4.70787,68.64522 -22.65665,94.0046 -27.36451,25.35939 -46.63738,24.63068 -80.475223,21.42432 C 39.523235,215.19885 22.31007,203.39363 31.872938,189.83947 41.435809,176.28532 67.476236,189.2565 73.802441,171.1843 80.128647,153.11209 45.555198,146.1164 57.472004,121.33999 Z"
                        id="underneath-road" />
                    <path
                        style="fill:none;stroke:#000000;stroke-width:9.3;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;"
                        d="M 57.472004,121.33999 C 76.009256,87.527484 80.275768,63.625541 96.900447,64.06277 c 16.624683,0.437232 12.946653,19.09241 9.562873,37.74759 -3.38378,18.65517 -4.26651,44.59753 7.50317,51.30173 11.76969,6.70421 14.85923,6.26698 18.8315,-5.68399 3.97227,-11.95098 -8.68014,-20.69559 -4.70787,-35.99867 3.97226,-15.303071 0.44136,-49.40707 21.33256,-56.402761 20.89118,-6.995691 26.92314,29.877434 27.07027,47.949631 0.14712,18.07221 4.70787,68.64522 -22.65665,94.0046 -27.36451,25.35939 -46.63738,24.63068 -80.475223,21.42432 C 39.523235,215.19885 22.31007,203.39363 31.872938,189.83947 41.435809,176.28532 67.476236,189.2565 73.802441,171.1843 80.128647,153.11209 45.555198,146.1164 57.472004,121.33999 Z"
                        id="road-tarmac" />
                    <path
                        style="fill:none;stroke:#ffcc00;stroke-width:0.25;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:1.75, 3;"
                        d="M 57.472004,121.33999 C 76.009251,87.527486 80.275763,63.62554 96.900442,64.062769 c 16.624678,0.437232 12.946658,19.09241 9.562868,37.747591 -3.38378,18.65517 -4.26651,44.59752 7.50318,51.30173 11.76968,6.7042 14.85922,6.26697 18.83149,-5.684 3.97227,-11.95098 -8.68014,-20.69559 -4.70787,-35.99866 3.97227,-15.30307 0.44137,-49.407072 21.33256,-56.402763 20.89118,-6.995691 26.92315,29.877435 27.07027,47.949633 0.14712,18.07221 4.70787,68.64522 -22.65665,94.0046 -27.36451,25.35938 -46.63737,24.63067 -80.475211,21.42431 -33.837849,-3.20637 -51.05101,-15.01159 -41.488146,-28.56575 9.562873,-13.55414 35.603303,-0.58297 41.929505,-18.65517 6.32621,-18.0722 -28.247243,-25.0679 -16.330434,-49.8443 z"
                        id="road-centerline" />
                </g>
            </g>
            <g id="car">
                <path
                    style="fill:#aa4400;stroke:#666666;stroke-width:0.15;stroke-linejoin:round;"
                    d="m -1.24,0 0.28,-5 1.9,0 0.28,5 0,1.4 l -2.46,0 z">
                </path>
                <rect
                    style="fill:#272727;stroke:#666666;stroke-width:0.1;stroke-linejoin:round;"
                    width="0.32"
                    height="1.1244452"
                    x="1.26"
                    y="-4">
                </rect>
                <rect
                    style="fill:#272727;stroke:#666666;stroke-width:0.1;stroke-linejoin:round;"
                    width="0.32"
                    height="1.1244452"
                    x="-1.59"
                    y="-4">
                </rect>
                <rect
                    style="fill:#272727;stroke:#666666;stroke-width:0.1;stroke-linejoin:round;"
                    width="0.32"
                    height="1.1244452"
                    x="1.4"
                    y="0">
                </rect>
                <rect
                    style="fill:#272727;stroke:#666666;stroke-width:0.1;stroke-linejoin:round;"
                    width="0.32"
                    height="1.1244452"
                    x="-1.74"
                    y="0">
                </rect>
                <rect
                    style="fill:#ade8ff;stroke:#666666;stroke-width:0.05;stroke-linejoin:round"
                    width=2
                    height=1.2
                    x=-1
                    y=-1.5>
                </rect>
            </g>
        </g>
        </g>
        <text id="pausetext" x="100" y="140" fill="white" font-family="sans-serif" font-size="18" text-anchor="middle" dominant-baseline="middle" style="-moz-user-select: none; -webkit-user-select: none; user-select: none;">Paused, click to start</text>

    </svg>

    <div style="margin-top:3px;padding-left:10%;">
        <canvas id="monitor" width=100 height=100 style="border:1px solid black;"></canvas> <svg style="position:relative;display:inline-flex;" width=100 height=100 viewbox="-15 -15 30 30" xmlns="http://www.w3.org/2000/svg"><circle cx=0 cy=0 r=0.5 fill=gray></circle><circle cx=0 cy=0 r=14.94 stroke-width=.05 stroke=black fill=none></circle><circle id="actdisplay" cx=0 cy=0 r=1 fill="darkblue"></circle></svg>
    </div>

    <script>

        // useful DOM nodes
        const course = document.getElementById("course");
        const car = document.getElementById("car");
        const everything = document.getElementById("everything");
        const gameview = document.getElementById("gameview");
        const monitor = document.getElementById("monitor");
        const actdisplay = document.getElementById("actdisplay");

        // constants for Car environment
        const frict = 0.02;         // all-directions friction
        const crossfrict = 0.04;    // cross-track additional friction
        const speedlimit = 1;       // min speed 0, max speed 1 (in SVG units per frame)
        const carsize = 0.6;        // scale the car graphic this much
        const zoom = 3;             // scale the course graphic this much
        const smoothrot = 0.9;      // how quickly do we rotate back to keeping the car vertical (1 = not, 0 = immediate)

        // object and method definitions for Car environment
        function Car() {
            this.reset();
        }

        // reset to initial state
        Car.prototype.reset = function () {
            this.x = 87;
            this.y = 219;
            this.dx = 0;
            this.dy = 0;
            this.th = -0.5*Math.PI;
            this.prevth = null;
        }

        // step forward with action (angvel, accel)
        // if we were in gym, we'd want to package up action as a tuple, and declare a Box action space
        // reasonable limits are [-6,6] for angvel, and [-3, 2] for accel 
        Car.prototype.step = function (angvel, accel) {
            let cth = Math.cos(this.th);
            let sth = Math.sin(this.th);
            this.dx += 0.02 * accel * sth;
            this.dy -= 0.02 * accel * cth;
            this.dx *= (1-frict);
            this.dy *= (1-frict);
            let along = this.dx * sth - this.dy * cth;
            let across = this.dx * cth + this.dy * sth;
            if (across > crossfrict) {
                across -= crossfrict;
            } else if (across < -crossfrict) {
                across += crossfrict;
            } else {
                across = 0;
            }
            if (along > speedlimit) {
                along = speedlimit;
            } else if (along < -0.0*speedlimit) {
                along = -0.0*speedlimit;
            }
            this.dx = along * sth + across * cth;
            this.dy = -along * cth + across * sth;
            if ((this.x < 0) && (this.dx < 0)) {
                this.dx = 0;
            } else if ((this.x > 200) && (this.dx > 0)) {
                this.dx = 0;
            }
            if ((this.y < 40) && (this.dy < 0)) {
                this.dy = 0;
            } else if ((this.y > 240) && (this.dy > 0)) {
                this.dy = 0;
            }
            this.x += this.dx;
            this.y += this.dy;
            this.th += angvel * .01;
            if (this.th > Math.PI) {
                this.th -= 2*Math.PI;
                this.prevth -= 2*Math.PI;
            } else if (this.th < -Math.PI) {
                this.th += 2*Math.PI;
                this.prevth += 2*Math.PI;
            }
            if (this.prevth === null) {
                this.prevth = this.th;
            } else {
                this.prevth = smoothrot * this.prevth + (1-smoothrot) * this.th;
            }
            // if we were in gym, we'd want to return observation, reward, done, diagnostic info
            // but we don't always want to compute the full observation, we haven't defined a reward, and done is always false
        }

        // render current state to a pre-existing SVG; arguments are references to SVG nodes for the car and the whole course
        Car.prototype.renderSVG = function(car, everything) {
            let cth = Math.cos(this.th);
            let sth = Math.sin(this.th);
            let a = carsize * cth;
            let b = carsize * sth;
            let c = -carsize * sth;
            let d = carsize * cth;
            car.style.transform = `matrix(${a},${b},${c},${d},${this.x},${this.y})`;
            cth = Math.cos(this.prevth);
            sth = Math.sin(this.prevth);
            a = zoom * cth;
            b = -zoom * sth;
            c = zoom * sth;
            d = zoom * cth;
            e = -(a * this.x + c * this.y) + 100;
            f = -(b * this.x + d * this.y) + 200;
            everything.style.transform = `matrix(${a},${b},${c},${d},${e},${f})`;
        }

        // convert an SVG to a raster image, represented as a Promise of an ImageData object
        // e.g., rasterize(gameview).then(img => ctx.putImageData(img, 0, 0));
        // where ctx is the output of Canvas.getContext("2d")
        function rasterize(svg, imgsize) {
            var svgimg = document.createElement("img");
            svgimg.src = "data:image/svg+xml;base64," + btoa(new XMLSerializer().serializeToString(svg));
            var svgcanvas = document.createElement("canvas");
            svgcanvas.width = imgsize;
            svgcanvas.height = imgsize;
            var ctx = svgcanvas.getContext("2d");
            return svgimg.decode().then(() => { 
                ctx.drawImage(svgimg, 0, 0, imgsize, imgsize); 
                return ctx.getImageData(0, 0, imgsize, imgsize); 
            });
        }

        var mousedx = 0;
        var mousedy = 0;
        var gamepad = null;
        var paused = true;
        var state = new Car();

        function handleClick(ev) {
            paused = !paused;
            if (paused) {
                document.getElementById("pausetext").style.fill = "white";
                document.exitPointerLock();
            } else {
                document.getElementById("pausetext").style.fill = "none";
                gameview.requestPointerLock();
                step();
            }
        }
        function handleMove(ev) {
            if (!paused) {
                mousedx += ev.movementX;
                mousedy += ev.movementY;
            }
        }
        function pollPad() {
            if (gamepad != null) {
                var gp = navigator.getGamepads()[gamepad];
                // console.log(gp.axes);
                // console.log(gp.buttons.map(x => x.pressed));
                // console.log(gp.buttons.map((x, i) => [i, x.value]));
                mousedx = 6 * gp.axes[0];
                mousedy = -2 * gp.buttons[7].value + 3 * gp.buttons[6].value;
            }
        }
        function step() {
            pollPad();
            state.step(mousedx, -mousedy);
            state.renderSVG(car, everything);
            if (!paused) {
                actdisplay.style.cx = mousedx;
                actdisplay.style.cy = mousedy;
                rasterize(gameview, 100).then(img => monitor.getContext("2d").putImageData(img, 0, 0));
            }
            mousedx = 0;
            mousedy = 0;
            if (!paused) {
                requestAnimationFrame(step);
            }
        }

        gameview.onclick = handleClick;
        gameview.onmousemove = handleMove;
        window.addEventListener("gamepadconnected", function (ev) { gamepad = ev.gamepad.index; console.log('gamepad connected'); });
        window.addEventListener("gamepaddisconnected", function(ev) { gamepad = null; console.log('gamepad disconnected'); });
    </script>
</body>